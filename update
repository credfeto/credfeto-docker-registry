#! /bin/sh

git pull

[ -d /data/registry ] || sudo mkdir -p /data/registry
[ -d /data/cache ] || sudo mkdir -p /data/cache

sudo docker volume create \
  --opt type=none \
  --opt o=bind \
  --opt device=/data/registry \
  registry-data

sudo docker volume create \
  --opt type=none \
  --opt o=bind \
  --opt device=/data/cache \
  registry-cache-data

sudo docker compose pull && sudo docker compose up -d --remove-orphans

sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="10.0.0.0/8" port protocol="tcp" port="8008" accept'
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.0.0/16" port protocol="tcp" port="8080" accept'
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="172.16.0.0/20" port protocol="tcp" port="8080" accept'

sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="10.0.0.0/8" port protocol="tcp" port="8081" accept'
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.0.0/16" port protocol="tcp" port="8081" accept'
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="172.16.0.0/20" port protocol="tcp" port="8081" accept'

sudo firewall-cmd --reload